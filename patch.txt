# KEYITEM-GRANT / SYSMSG-UNIFY パッチ（手動差し替え用）
# ※ world.gd / game_hud.gd は 1000行超のため、差し替え関数のみ記載します。
# 既存ファイル内の同名関数を「丸ごと置換」してください。
#
# 対象:
# - res://scripts/world.gd
# - res://ui/game_hud.gd（プロジェクト側の実ファイル名に合わせてください）
#
# 目的:
# - World._world_message の mode を "system" に統一
# - GameHUD._on_supply_event は mode=="system" のとき DialogPlayer に表示を委譲（トースト廃止）


## world.gd: func _world_message

func _world_message(txt: String) -> void:
    if txt == "":
        return
    # 受け渡しID（都市名/商品名など）をローカライズしてから通知
    if has_method("humanize_ids"):
        txt = humanize_ids(txt)
    _log(txt)

    # UI側で「システムメッセージ」として扱えるよう mode を system に統一
    supply_event.emit("", "", 0, "system", txt)


## game_hud.gd: func _on_supply_event

func _on_supply_event(cid: String, pid: String, qty: int, mode: String, flavor: String) -> void:
    # World 側の humanize_ids は既に掛かっている想定だが、念のため二重保険
    var txt := flavor
    if world and world.has_method("humanize_ids"):
        txt = world.humanize_ids(txt)

    # ★ システムメッセージはトースト/AcceptDialog ではなく DialogPlayer に統一
    if mode == "system":
        if dialog_player and dialog_player.has_method("show_system_message"):
            dialog_player.call("show_system_message", txt)
        else:
            # フォールバック（念のため）
            _show_toast(txt)
        _refresh_event_log()  # イベントログは更新
        return

    # ここから下は「噂/イベント」系（従来どおり）
    if show_supply_dialog:
        var dlg := AcceptDialog.new()
        dlg.title = "市場の噂"
        dlg.dialog_text = txt
        add_child(dlg)
        dlg.popup_centered()
        _sync_pause_state()
        dlg.confirmed.connect(func():
            if is_instance_valid(dlg):
                dlg.hide()
                dlg.queue_free()
            call_deferred("_sync_pause_state")
        )
        dlg.close_requested.connect(func():
            if is_instance_valid(dlg):
                dlg.hide()
                dlg.queue_free()
            call_deferred("_sync_pause_state")
        )
        dlg.visibility_changed.connect(func():
            call_deferred("_sync_pause_state")
        )
        dlg.grab_focus()
    else:
        _show_toast(txt)

    _refresh_event_log()  # ★ イベントログを即時更新
